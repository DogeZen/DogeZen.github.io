---
title: 推送舍友联系方式脚本
date: 2021-07-25 17:17:03
tags:
- python
---

```python
import copy
import os
import smtplib
import time
from email.mime.text import MIMEText
from email.utils import formataddr

from openpyxl import load_workbook

my_sender = 'zhldodge@qq.com'  # 发件人邮箱账号
my_pass = '填你自己的邮箱授权码'  # 发件人邮箱授权码


def mail(email_content, subject, my_user, num):
    ret = True
    try:
        msg = MIMEText(email_content, 'plain', 'utf-8')
        msg['From'] = formataddr(["柴犬", my_sender])  # 括号里的对应发件人邮箱昵称、发件人邮箱账号
        msg['To'] = formataddr([num, my_user])  # 括号里的对应收件人邮箱昵称、收件人邮箱账号
        msg['Subject'] = subject  # 邮件的主题，也可以说是标题

        server = smtplib.SMTP_SSL("smtp.qq.com", 465)  # SMTP服务器，端口
        server.login(my_sender, my_pass)  # 账号、邮箱密码
        server.sendmail(my_sender, [my_user, ], msg.as_string())  # 括号中对应的是发件人邮箱账号、收件人邮箱账号、发送邮件
        server.quit()  # 关闭连接
    except Exception as e:
        print(e)
        ret = False
    return ret


datas = {}
nums = []
for excel in os.listdir("excel"):
    wb = load_workbook(os.path.join("excel", excel))
    sheet = wb.worksheets[0]
    data = sheet.rows
    flag = 0
    for row in data:
        if flag == 0:
            flag = 1
            continue
        single_data = {'gender': row[6].value,
                       'contact': row[8].value,
                       'mail': row[9].value
                       }
        # print(single_data)
        
        datas[int(row[7].value)] = copy.deepcopy(single_data)
        if int(row[7].value) not in nums:
            nums.append(int(row[7].value))

for num in nums:
    content = "首先感谢您完成了答卷，您所填的学号为" + str(num) + "\n\n以下可能是您的舍友信息:\n\n"
    roommate_nums = []
    possible_nums = [num + i for i in range(-5, 6)]
    for possible_num in possible_nums:

        if possible_num in nums and possible_num != num:
            if datas[possible_num]['gender'] == datas[num]['gender']:
                roommate_nums.append(possible_num)
                content += "学号为 " + str(possible_num) + "联系方式为" + datas[possible_num]['contact'] + "\n"
    if roommate_nums:
        if len(roommate_nums) == 1:
            content += "\n俩人找到彼此不容易，相逢是缘，彼此珍惜\n"
        elif len(roommate_nums) == 2:
            content += "\n三缺一了属于是，祝相处愉快\n"
        else:
            content += "\n这都要凑齐一整个宿舍了，祝相处愉快\n"
        print(content)
    else:
        content += "很遗憾未查到您的舍友信息,请期待后续推送\n"
        print(content)

    my_user = datas[num]['mail']  # 收件人邮箱账号

    mail(content, "舍友信息推送", my_user, str(num))
    time.sleep(20)
```
