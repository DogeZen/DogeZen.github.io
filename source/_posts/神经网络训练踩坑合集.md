---
title: 神经网络训练踩坑合集
date: 2021-07-27 16:03:21
tags:
- 神经网络
- 踩坑
---

## 预处理

**1.ImageFolder读取时需要补零**

1.jpg,2.jpg,3.jpg .....999.jpg,1000.jpg

需要补零为0001.jpg,0002.jpg...0999.jpg,1000.jpg。

否则会顺序混乱。

**2.通道转换用transpose，而不是reshape**

把图像从[n,w,h,c]转为[n,c,w,h]时一定要注意用np.transpose。

不然整个图像会先被压为一维特征，然后再排列，而不是直接维度上转置。

**3.pytorch ToTensor对部署的影响**

transforms.ToTensor()操作之后，图像会从*[0, 255] -> [0.0,1.0]*

部署时需要image /= 255.0

## 训练

**1.train,eval 调整**

老生常谈了，训练时候记得切换。

**2.scheduler.step() optimizer.step() 位置写错**

这里可以用tensorboard实时监控学习率解决，防止写错位置学习率骤降

**3.忘记optimizer.zero_grad()**

## 模型保存

**1.save和load方法要对应**

尽量直接save model，而不是model.state_dict(),这样方便恢复训练

```python
torch.save(model, model_path)
model = torch.load(model_path)
model.eval()
torch.save(model.state_dict(), PATH)
model = init_model() # 这里还需要初始化模型结构才能载入state dict
model.load_state_dict(torch.load(PATH))
model.eval()
```



## 最终的解决方法

1.训练时用tensorboard监控学习率，处理图像时把预处理结束的图像放在tensorboard上。

2.如果模型不拟合，先用最少的样本测试模型能不能过拟合，测试整个流程有没有出问题。

3.尽量自己手写工具类，形成自己的代码库。防止出bug大量浪费时间。
